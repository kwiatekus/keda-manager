---
apiVersion: v1
kind: Secret
metadata:
  name: dynatrace-secret
  namespace: keda-dynatrace
type: Opaque
data:
  host: # base64 encoded host URL of your Dynatrace environment (without the /api/v2/ prefix)
  token: # base64 encoded Dynatrace API token (dt0c01.VKNWE3ZBA....) with `metrics.read` permission 
---
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: dynatrace-trigger-auth
  namespace: keda-dynatrace
spec:
  secretTargetRef:
  - parameter: token
    name: dynatrace-secret
    key: token 
  - parameter: host
    name: dynatrace-secret
    key: host
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: httpbin-dynatrace-scaler
  namespace: keda-dynatrace
spec:
  scaleTargetRef:
    name: httpbin
  minReplicaCount: 1 # Adjust the minimum replica count as needed
  maxReplicaCount: 10 # Adjust the maximum replica count as needed
  pollingInterval: 5 # seconds (Adjust the polling interval as needed)
  triggers:
    - type: dynatrace
      metadata:
        # Dynatrace metric selector for Istio request rate (adjust as needed)
        metricSelector: 'istio_requests_total.count:splitBy("destination_service"):filter(eq("destination_service","httpbin.keda-dynatrace.svc.cluster.local")):auto:rate(1m)'
        from: 'now-1h'
        threshold: '1' # Adjust the threshold as needed
      authenticationRef:
        name: dynatrace-trigger-auth 
